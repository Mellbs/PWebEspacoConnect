<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastro</title>
    <link rel="icon" href="images/logo - Copia.png" type="image/png">   
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="lib/bootstrap/css/bootstrap.min.css">
    <style>
        .error {
            color: red;
            font-size: 12px;
            display: block;
            margin-top: 4px;
        }
    </style>
</head>

<body class="login">
    <div class="row" style="width: 100%;">
        <div class="col-md-6 d-flex justify-content-center align-items-center">
            <img src="images/calendar.png" alt="Foto da tela inicial"
                style="height: 600px; width: 80%; object-fit: cover; margin-top: -0px;">
        </div>
        <div class="col-md-4">
            <div class="container container-index" style="height: 600px; overflow-y: auto; padding: 20px;">
                <h2 style="text-align: center; color: #004aad; font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif; font-weight: bold;">CADASTRO</h2>
                <form id="form-cadastro">
                    <label for="email" style="color: #004aad; font-weight: bold;">E-mail</label>
                    <input type="email" id="email" required>

                    <label for="name" style="color: #004aad; font-weight: bold;">Nome de usuário</label>
                    <input type="text" id="name" required>

                    <label for="senha" style="color: #004aad; font-weight: bold;">Senha</label>
                    <input type="password" id="senha" required>
                    <span id="senha-error" class="error"></span>

                    <label for="confirma" style="color: #004aad; font-weight: bold;">Confirmar senha</label>
                    <input type="password" id="confirma" required>
                    <span id="confirma-error" class="error"></span>
                    <br>
                    <button type="submit" style="font-weight: bold;">Cadastrar</button>
                    <div class="register" style="font-weight: bold;">
                        <span>Já tem uma conta?</span>
                        <a href="index.html">Faça login</a>
                    </div>
                    <span id="dominio-error" class="error"></span>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Constante com o único e-mail permitido para gerente
        const ALLOWED_GERENTE = 'guilherme.muniz.souza11@gerente.com';

        // Selecione o formulário
        const form = document.getElementById('form-cadastro');

        // Adicione um evento de submit ao formulário
        form.addEventListener('submit', (e) => {
            // Previna o comportamento padrão do formulário
            e.preventDefault();

            // Obtenha e normalize os valores dos campos
            const emailInput = document.getElementById('email');
            const nameInput = document.getElementById('name');
            const senhaInput = document.getElementById('senha');
            const confirmaInput = document.getElementById('confirma');

            const email = emailInput.value.trim().toLowerCase();
            const name = nameInput.value.trim();
            const senha = senhaInput.value;
            const confirma = confirmaInput.value;

            const senhaError = document.getElementById('senha-error');
            const confirmaError = document.getElementById('confirma-error');
            const dominioError = document.getElementById('dominio-error');

            // Limpa mensagens
            senhaError.textContent = '';
            confirmaError.textContent = '';
            dominioError.textContent = '';

            // Verifique se as senhas coincidem
            if (senha !== confirma) {
                confirmaError.textContent = 'As senhas não coincidem!';
                return;
            }

            let tipo;
            let redirectUrl;

            // Regras de e-mail
            if (email === ALLOWED_GERENTE) {
                // ÚNICO gerente permitido
                tipo = 'gerente';
                redirectUrl = 'senha-gerente.html';
            } else if (email.endsWith('@gerente.com')) {
                // Qualquer outro @gerente.com é recusado
                dominioError.textContent = 'Apenas o e-mail ' + ALLOWED_GERENTE + ' pode se cadastrar como gerente.';
                return;
            } else if (email.endsWith('@usuario.com')) {
                // Usuário comum válido
                tipo = 'usuario';
                redirectUrl = 'tela-inicial.html';
            } else {
                dominioError.textContent = 'Domínio de e-mail inválido. Use @usuario.com ou o e-mail autorizado de gerente.';
                return;
            }

            // Crie um objeto com as informações do usuário
            const usuario = {
                email,
                username: name,
                senha,
                role: tipo
            };

            // Envie os dados para o servidor para salvar no banco de dados
            fetch('../api/admin/usuarios_adicionar.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    nome: name,
                    email: email,
                    senha: senha,
                    papel: tipo
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Armazene o objeto no LocalStorage
                    localStorage.setItem('usuario', JSON.stringify(usuario));
                    localStorage.setItem('currentUser', JSON.stringify(usuario));

                    // Redirecione para a página correspondente
                    window.location.href = redirectUrl;
                } else {
                    dominioError.textContent = data.mensagem;
                }
            })
            .catch(error => {
                console.error('Erro ao cadastrar:', error);
                dominioError.textContent = 'Erro ao cadastrar. Tente novamente.';
            });
        });
    </script>
</body>

</html>
